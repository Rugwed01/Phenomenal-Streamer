<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Backend Engine Test</title>
    <style>
        body { font-family: sans-serif; background: #222; color: #fff; text-align: center; }
        video { background: black; max-width: 80%; border: 2px solid #444; margin-top: 20px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>
    <h1>RTSP to HLS Transcoding</h1>
    <div id="status">Waiting for stream to become available...</div>

    <video id="videoPlayer" controls autoplay muted style="display: none;"></video>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const video = document.getElementById('videoPlayer');
            const statusDiv = document.getElementById('status');
            const videoSrc = '/stream/hls/stream.m3u8';

            function initializePlayer() {
                if (Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(videoSrc);
                    hls.attachMedia(video);
                    // When the player is ready, show the video and hide the status message
                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        statusDiv.style.display = 'none';
                        video.style.display = 'block';
                    });
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    video.src = videoSrc;
                    statusDiv.style.display = 'none';
                    video.style.display = 'block';
                }
            }

            // --- THE FIX: Poll for the playlist file ---
            const interval = setInterval(() => {
                // Use fetch to check if the file exists
                fetch(videoSrc)
                    .then(response => {
                        // If we get a 200 OK response, the stream is ready!
                        if (response.ok) {
                            console.log('âœ… Stream is ready!');
                            clearInterval(interval); // Stop polling
                            initializePlayer();     // Start the video player
                        } else {
                            console.log('Stream not ready yet, waiting...');
                        }
                    })
                    .catch(error => console.error('Polling error:', error));
            }, 2000); // Check every 2 seconds
        });
    </script>
</body>
</html>